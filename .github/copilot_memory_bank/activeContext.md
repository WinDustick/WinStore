# Текущий контекст работы с базой данных WinStore

## Последние изменения

В соответствии с философией "Absurdly Ideal Code", мы провели существенный рефакторинг структуры базы данных WinStore. Основные изменения включали:

1. **Перемещение сложной бизнес-логики в прикладной слой**:
   - Удалены триггеры `TR_Orders_UpdateAmount` и `TR_OrderItems_AdjustStock`
   - Бизнес-логика расчета сумм заказа и управления складскими остатками перенесена в бэкенд-приложение

2. **Упрощение модели доставки**:
   - Удалена таблица `Delivery`
   - Информация о доставке теперь хранится непосредственно в таблице `Orders`

3. **Введение справочных таблиц для статусов**:
   - Созданы таблицы `OrderStatusTypes`, `PaymentStatusTypes`, `DeliveryStatusTypes`
   - Строковые статусы заменены на внешние ключи к справочникам

4. **Нормализация таблицы `Payments`**:
   - Удалено поле `user_ID`
   - Удалён композитный внешний ключ `FK_Payments_Order_User`
   - Проверка прав пользователя на создание платежа перенесена в прикладной слой

5. **Стандартизация типов данных для строк**:
   - Изменен тип данных с `NCHAR` на `NVARCHAR` для полей с переменной длиной

## Текущие приоритеты

1. **Адаптация бэкенд-приложения**:
   - Реализация логики расчета суммы заказа и работы со скидками
   - Реализация логики управления складскими остатками
   - Валидация прав пользователей при создании платежей

2. **Обновление Django ORM моделей**:
   - Приведение моделей в соответствие с новой структурой БД
   - Реализация сервисных классов для работы с бизнес-логикой

3. **Настройка Directus**:
   - Создание необходимых представлений для работы с Directus
   - Настройка прав доступа и ролей в Directus

## Технические особенности и ограничения

1. **Транзакции**:
   - Важно обеспечить атомарность операций на уровне приложения, которые раньше обеспечивались триггерами
   - Использовать транзакции Django для обновления связанных данных

2. **Валидация данных**:
   - Реализовать тщательную валидацию на уровне приложения перед сохранением в БД
   - Особое внимание уделить проверкам прав доступа при работе с платежами

3. **Производительность**:
   - Мониторить производительность запросов после рефакторинга
   - При необходимости создавать дополнительные индексы
   - Оптимизировать запросы к справочным таблицам статусов

## Текущие вопросы и исследования

1. Определение оптимальной стратегии кэширования для справочников статусов
2. Исследование производительности запросов с новой структурой БД
3. Разработка стратегии миграции данных из старой структуры в новую
