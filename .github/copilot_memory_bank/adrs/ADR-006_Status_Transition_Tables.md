# ADR-006: Декларативное определение разрешенных переходов между статусами

## Статус

Принято (2025-05-15)

## Контекст

В системе WinStore используются справочные таблицы для хранения возможных статусов сущностей (OrderStatusTypes, PaymentStatusTypes, DeliveryStatusTypes). Однако, не все переходы между статусами являются допустимыми с точки зрения бизнес-процессов. Например, заказ не может перейти из статуса "Доставлен" в статус "Обрабатывается".

Существовало несколько подходов к контролю допустимых переходов:
1. Хранить правила переходов в виде кода на уровне бэкенд-приложения
2. Использовать хранимые процедуры с жесткой логикой проверки переходов
3. Создать отдельную таблицу, описывающую разрешенные переходы между статусами

## Рассмотренные варианты

### Вариант 1: Кодирование правил в приложении
**Преимущества:**
- Полный контроль над логикой в коде
- Возможность сложных условных проверок

**Недостатки:**
- Изменение бизнес-процесса требует изменения кода и его перевыпуска
- Сложно документировать и визуализировать процесс
- Риск несогласованности при множественных точках проверки

### Вариант 2: Хранимые процедуры с логикой проверки
**Преимущества:**
- Централизация логики на уровне БД
- Атомарность проверок

**Недостатки:**
- Противоречит принятому решению о переносе бизнес-логики в приложение (ADR-001)
- Сложно поддерживать и модифицировать процедурный код
- Затруднена документация и визуализация

### Вариант 3: Декларативная таблица переходов
**Преимущества:**
- Четкое декларативное определение допустимых переходов
- Легкая модификация бизнес-процессов без изменения кода
- Единая точка истины для правил переходов
- Возможность самодокументирования процесса через представления
- Возможность динамического построения UI на основе доступных переходов

**Недостатки:**
- Дополнительная таблица в схеме данных
- Ограниченная выразительность для сложных условных переходов

## Принятое решение

Выбран Вариант 3. Создана таблица `OrderStatusTransitions`, которая декларативно определяет допустимые переходы между статусами заказов. Таблица содержит поля:
- from_status_ID (из какого статуса)
- to_status_ID (в какой статус)
- is_allowed (разрешен ли переход)
- transition_name (название перехода для UI)

Проверка допустимости перехода выполняется на уровне приложения через запрос к этой таблице.

## Обоснование

* **Соответствие "Absurdly Ideal Code":** Декларативный подход проще, надежнее и понятнее императивного.
* **Гибкость:** Изменение бизнес-процессов не требует изменения кода.
* **Самодокументируемость:** Таблица и представления на ее основе автоматически документируют бизнес-процесс.
* **Разделение ответственности:** База данных хранит правила, приложение применяет их и добавляет специфичную логику.

## Последствия

* В будущем подобный подход может быть применен к другим статусным сущностям (PaymentStatusTransitions, DeliveryStatusTransitions).
* Приложение должно запрашивать допустимость перехода перед изменением статуса.
* Можно создать вспомогательные представления и хранимые процедуры для облегчения работы с таблицей переходов.
* Пользовательский интерфейс может динамически адаптироваться к доступным переходам для текущего статуса заказа.
