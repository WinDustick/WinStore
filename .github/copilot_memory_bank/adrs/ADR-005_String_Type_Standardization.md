# ADR-005: Стандартизация использования типов данных для строк (`NVARCHAR` вместо `NCHAR`)

## Статус

Принято (2025-05-09)

## Контекст

В текущей схеме базы данных WinStore используются различные типы данных для хранения строковых значений, включая `NCHAR` фиксированной длины и `NVARCHAR` переменной длины. Это создает несогласованность и потенциальные проблемы с производительностью и хранением.

Фиксированная длина (`NCHAR`) используется для полей, где длина данных предполагается одинаковой, например, для кодов валют, но фактически во многих случаях длина данных может варьироваться.

## Рассмотренные варианты

### Вариант 1: Оставить текущую структуру (микс NCHAR и NVARCHAR)
**Преимущества:**
- Нет необходимости вносить изменения в существующие таблицы
- Для некоторых полей с фиксированной длиной (например, коды валют) NCHAR может быть более подходящим типом

**Недостатки:**
- Несогласованность в использовании типов данных в базе данных
- Потенциальная неэффективность хранения, когда данные короче, чем выделенное пространство
- Риск потери данных, если вставляемые значения длиннее выделенного пространства
- Дополнительная сложность при форматировании данных (удаление пробелов)

### Вариант 2: Стандартизация на NVARCHAR для всех строковых полей с переменной длиной
**Преимущества:**
- Согласованность в использовании типов данных
- Более эффективное использование пространства для переменной длины данных
- Упрощение работы с данными (не требуется TRIM)
- Соответствие современным практикам проектирования БД

**Недостатки:**
- Необходимость изменения существующих таблиц
- Для полей с действительно фиксированной длиной может быть неоптимально

### Вариант 3: Индивидуальный анализ каждого поля и выбор наиболее подходящего типа
**Преимущества:**
- Потенциально наиболее оптимальное использование для каждого конкретного случая

**Недостатки:**
- Трудоемкий процесс анализа
- Риск субъективных решений и остаточной несогласованности
- Усложнение стандартов и документации

## Принятое решение

Выбран Вариант 2. Стандартизировать использование `NVARCHAR` для всех строковых полей с потенциально переменной длиной. Специфические поля с фиксированной длиной (например, `currency` для валютных кодов, который всегда имеет длину 3 символа) могут остаться как `NCHAR`.

В частности, изменить следующие поля:
- `user_NAME`, `user_EMAIL`, `user_PHONE`, `user_ROLE` в таблице `Users` с `NCHAR` на `NVARCHAR`
- `status_KEY`, `status_NAME_RU`, `status_DESCRIPTION_RU` в таблицах статусов с `NCHAR` на `NVARCHAR`
- `promo_CODE`, `promo_NAME`, `discount_TYPE` в таблице `Promotions` с `NCHAR` на `NVARCHAR`
- `target_TYPE` в таблице `PromotionApplications` с `NCHAR` на `NVARCHAR`
- `payment_METHOD`, `payment_STATUS`, `transaction_ID` в таблице `Payments` с `NCHAR` на `NVARCHAR`

## Обоснование

* **Соответствие "Absurdly Ideal Code":** Стандартизированное использование наиболее подходящего типа данных для каждого случая делает код более понятным и предсказуемым.
* **Эффективность хранения:** `NVARCHAR` требует только фактически используемое пространство плюс минимальный overhead.
* **Упрощение работы с данными:** Нет необходимости в дополнительной обработке (RTRIM, LTRIM) при сравнении или отображении строк.
* **Безопасность данных:** Устраняются риски потери данных из-за усечения при вставке строк, длиннее выделенного пространства.

## Последствия

1. Схема базы данных будет обновлена для изменения типов данных.
2. Существующие данные будут сконвертированы, что может потребовать временного отключения системы.
3. Записи в таблицы, которые могли быть вставлены без проверки длины, теперь должны явно проверяться на максимальную длину.
4. Системы, взаимодействующие с БД, могут потребовать обновления, если они жестко привязаны к текущим типам данных.
5. Новые разработки должны следовать стандарту использования `NVARCHAR` для строковых полей с переменной длиной и `NCHAR` только для строк с действительно фиксированной длиной.
