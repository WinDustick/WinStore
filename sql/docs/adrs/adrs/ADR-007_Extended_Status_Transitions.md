# ADR-007: Расширение паттерна декларативных переходов на все типы статусов

## Статус

Принято (2025-05-18)

## Контекст

После успешного внедрения таблицы `OrderStatusTransitions` для декларативного определения разрешенных переходов между статусами заказов, возник вопрос о применении аналогичного подхода к другим статусным сущностям: `PaymentStatusTypes` и `DeliveryStatusTypes`. Необходимо было оценить соотношение пользы и издержек такого расширения.

## Рассмотренные варианты

### Вариант 1: Расширить подход на все типы статусов
**Преимущества:**
- Унификация подхода ко всем статусным сущностям
- Полнота документирования бизнес-процессов
- Единообразие API для проверки переходов
- Возможность визуализации всех процессов

**Недостатки:**
- Увеличение количества таблиц и объема данных
- Дополнительные запросы к БД при каждом изменении статуса
- Потенциальная избыточность для простых линейных процессов

### Вариант 2: Применить подход только к заказам
**Преимущества:**
- Меньшее количество таблиц
- Простота поддержки
- Снижение количества запросов

**Недостатки:**
- Непоследовательность в архитектуре (разные подходы к похожим сущностям)
- Дублирование логики для разных типов статусов в коде
- Отсутствие единой документации процессов

### Вариант 3: Гибридный подход с избирательным применением
**Преимущества:**
- Оптимизация под конкретные сценарии
- Баланс между документированием и сложностью

**Недостатки:**
- Повышение сложности архитектуры
- Неочевидность, к каким сущностям применен паттерн
- Сложность поддержки разнородных подходов

## Принятое решение

Выбран Вариант 1: Расширить паттерн декларативных переходов на все типы статусов. Созданы таблицы `PaymentStatusTransitions` и `DeliveryStatusTransitions`, аналогичные `OrderStatusTransitions`. Также созданы соответствующие представления и хранимые процедуры для работы с ними, включая унифицированную процедуру `sp_ValidateStatusTransition` для проверки переходов любого типа.

## Обоснование

* **Унификация и последовательность:** Единый подход ко всем статусам делает систему более понятной.
* **Разделение ответственности:** Сохраняется принцип хранения правил в БД и валидации в приложении.
* **Экономия трудозатрат:** Упрощаются модификации бизнес-процессов и их документирование.
* **Надежность:** Декларативное определение переходов снижает вероятность ошибок.
* **Производительность:** Издержки на дополнительные запросы минимальны, поскольку изменения статусов происходят относительно редко.

## Последствия

* Унифицирован подход к валидации переходов статусов во всей системе
* Создан единый API для проверки допустимости переходов
* Повышена прозрачность бизнес-процессов
* Backend-приложение должно использовать таблицы переходов для всех изменений статусов
* Создана основа для визуализации бизнес-процессов

## Примечания по реализации

* Сохраняется возможность добавления сложных условных проверок на уровне приложения, когда таблица переходов определяет только базовые возможности перехода.
* В будущем можно рассмотреть добавление временных ограничений (например, запрет определенных переходов после истечения срока) или условных переходов на уровне приложения.
