# ADR-008: Реорганизация файлов SQL и внедрение единой структуры скриптов

## Статус

Принято (2025-05-28)

## Контекст

По мере развития базы данных WinStore количество SQL-скриптов увеличивалось, что привело к следующим проблемам:

1. **Несогласованность файлов**: Разные SQL файлы использовали разные стили форматирования, подходы к обработке ошибок и структуру.
2. **Сложность развертывания**: Отсутствие четкой последовательности выполнения файлов затрудняло развертывание базы данных.
3. **Недостаточная документация**: Многие файлы не имели достаточных комментариев или заголовков, объясняющих их назначение и зависимости.
4. **Смешение объектов разного типа**: В одном файле часто определялись таблицы, представления, процедуры и другие объекты, что затрудняло поиск и поддержку.
5. **Отсутствие проверок существования**: Многие скрипты не проверяли существование объектов перед их созданием или модификацией.

## Рассмотренные варианты

### Вариант 1: Сохранение текущей структуры без изменений
**Преимущества:**
- Нет необходимости в миграции существующих скриптов
- Разработчики привыкли к текущей структуре

**Недостатки:**
- Не решает перечисленные выше проблемы
- Сложности будут нарастать по мере роста базы данных

### Вариант 2: Автоматическая генерация SQL с использованием ORM
**Преимущества:**
- Согласованная структура SQL
- Автоматическое управление зависимостями

**Недостатки:**
- Ограничения выразительности SQL, генерируемого ORM
- Сложность контроля над производительностью сгенерированных запросов
- Потеря контроля над схемой базы данных

### Вариант 3: Логическая реорганизация файлов с четкой структурой каталогов
**Преимущества:**
- Логическая группировка объектов базы данных
- Понятная последовательность выполнения
- Возможность внедрения стандартов форматирования и документирования
- Сохранение полного контроля над SQL

**Недостатки:**
- Требуются усилия для реорганизации существующих файлов
- Необходимость соблюдения разработчиками новой структуры

## Принятое решение

Выбран Вариант 3. Реорганизовать файлы SQL в логическую структуру каталогов и внедрить единые стандарты оформления скриптов.

Новая структура выглядит следующим образом:

/sql/
├── README.md                       # Documentation for SQL files
├── deploy.sql                      # Master deployment script
│
├── 01_schema/                      # Database structure
│   ├── 01_core_schema.sql          # Database creation and tables
│   ├── 02_reference_data.sql       # Status type tables and initial data
│   ├── 03_status_transitions.sql   # Status transition tables and data
│   └── 04_indexes.sql              # All indexes for performance optimization
│
├── 02_audit/
│   └── audit_setup.sql             # Audit system configuration
│
├── 03_views/
│   ├── product_views.sql           # Views for products (GPU, CPU, RAM)
│   └── system_views.sql            # Views for statuses, etc.
│
├── 04_procedures/
│   ├── product_procedures.sql      # Product-related procedures
│   ├── order_procedures.sql        # Order-related procedures
│   ├── payment_procedures.sql      # Payment-related procedures
│   └── user_procedures.sql         # User-related procedures
│
└── 05_triggers/
    └── triggers.sql                # Triggers (timestamp updates)


Кроме того, введены следующие стандарты:

1. Каждый файл должен начинаться с стандартного заголовка с описанием, автором, датой и зависимостями.
2. Объекты одного типа (таблицы, представления, процедуры) должны быть сгруппированы в соответствующие файлы/каталоги.
3. Перед созданием объекта должна проводиться проверка его существования.
4. Все хранимые процедуры должны включать обработку ошибок с TRY-CATCH блоками.
5. Все имена объектов должны следовать единому соглашению об именовании.
6. Все SQL-запросы должны быть должным образом отформатированы для обеспечения читаемости.

## Обоснование

* **Соответствие "Absurdly Ideal Code":** Новая структура максимально проста, логична и понятна, что соответствует принципу KISS.
* **Поддерживаемость:** Логическая группировка объектов упрощает навигацию и поиск по кодовой базе.
* **Надежность:** Стандартные заголовки и проверки существования объектов повышают надежность скриптов.
* **Документированность:** Стандартизированные комментарии и заголовки улучшают документацию базы данных.
* **Последовательность развертывания:** Мастер-скрипт deploy.sql обеспечивает корректную последовательность выполнения файлов.

## Последствия

1. Все существующие SQL-скрипты были реорганизованы в соответствии с новой структурой.
2. Создан мастер-скрипт deploy.sql, который упрощает развертывание базы данных.
3. Внедрены единые стандарты форматирования и документирования SQL-кода.
4. Добавлены проверки существования объектов перед их созданием или изменением.
5. Улучшена обработка ошибок в хранимых процедурах с использованием TRY-CATCH блоков.
6. Необходимо обучить разработчиков новой структуре и стандартам.
7. Системы CI/CD должны быть обновлены для использования нового мастер-скрипта.

Эти изменения существенно повышают поддерживаемость и качество SQL-кода в проекте, что соответствует философии "Absurdly Ideal Code", принятой в проекте.