# ADR-001: Перенос сложной бизнес-логики из триггеров БД в прикладной уровень

## Статус

Принято (2025-05-09)

## Контекст

В предыдущей версии структуры базы данных часть бизнес-логики (например, расчет общей суммы заказа в `Orders` при изменении `OrderItems`, обновление складских остатков `Products.product_STOCK` при операциях с `OrderItems`) была реализована с помощью триггеров MS SQL. Это обеспечивало немедленную согласованность данных на уровне БД.

## Рассмотренные варианты

1. **Оставить логику в триггерах:** Гарантирует выполнение логики независимо от клиента БД, но усложняет тестирование, отладку, управление транзакциями на уровне бизнес-процессов и может приводить к проблемам с производительностью и блокировками.

2. **Перенести логику в хранимые процедуры:** Несколько лучше для тестирования, чем триггеры, но все еще оставляет бизнес-логику в БД.

3. **Перенести логику в прикладной уровень (бэкенд):** Бизнес-логика реализуется в коде приложения (например, Python/Django).

## Принятое решение

Выбран Вариант 3. Удалены триггеры `TR_Orders_UpdateAmount` и `TR_OrderItems_AdjustStock`. Логика расчета суммы заказа и обновления остатков должна быть реализована в прикладном слое.

## Обоснование

* **Соответствие "Absurdly Ideal Code":** Четкое разделение ответственности (SoC) – БД для хранения и целостности данных, приложение – для бизнес-логики.
* **Тестируемость:** Бизнес-логику в коде приложения значительно проще покрывать unit- и integration-тестами.
* **Поддерживаемость и Читаемость:** Логика на языке приложения обычно более понятна и легче модифицируется разработчиками приложений.
* **Управление транзакциями:** Приложение может управлять более сложными, распределенными или бизнес-транзакциями, охватывающими несколько операций.
* **Масштабируемость:** Слой приложения легче масштабировать горизонтально, чем БД.

## Последствия

* Требуется доработка прикладного уровня для реализации этой логики и обеспечения ее корректного и атомарного выполнения (через транзакции приложения).
* Повышается ответственность разработчиков приложения за поддержание согласованности данных, ранее обеспечиваемой триггерами.
* Упрощается структура БД и снижается вероятность неявного поведения, вызванного триггерами.
