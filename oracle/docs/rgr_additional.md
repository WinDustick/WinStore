# Документация вспомогательных функций (Status Lookup Helpers)

Этот раздел описывает отдельные (standalone) функции, расположенные в схеме базы данных. Они не входят в пакеты, так как являются универсальными утилитами для использования в различных частях системы (SQL-скрипты загрузки данных, триггеры, процедуры).

## Общий паттерн реализации

Все три функции следуют единому архитектурному паттерну **"Key-to-ID Resolver"**.

  * **Вход:** Строковый ключ статуса (`NVARCHAR2`), например, `'Pending'`.
  * **Логика:** Выполняется поиск первичного ключа (`ID`) в соответствующей таблице-справочнике.
  * **Выход:** Числовой идентификатор (`NUMBER`).
  * **Обработка ошибок:** Если статус не найден, функция не выбрасывает исключение (что прервало бы транзакцию), а возвращает `NULL`. Это позволяет вызывающему коду (например, процедуре валидации) самому решать, как реагировать на ошибку.

-----

## Детальный разбор функций

### 1\. Функция `get_order_status_id`

  * **Зачем? (Назначение):**
    Позволяет оперировать понятными текстовыми ключами статусов заказов (например, `'Shipped'`, `'Cancelled'`) в программном коде, избегая "магических чисел" (хардкодинга ID). Это критически важно для переносимости кода, так как ID могут измениться при пересоздании базы, а ключи зафиксированы в бизнес-логике.

  * **Как? (Реализация):**
    Выполняет запрос `SELECT status_ID INTO ... FROM OrderStatusTypes WHERE status_KEY = ...`. Содержит блок `EXCEPTION WHEN NO_DATA_FOUND` для безопасной обработки несуществующих ключей.

  * **Где? (Расположение и использование):**

      * **Определение:** Файл `oracle/01_schema/03_status_transitions.sql`.
      * **Использование:** В процедуре `sp_QuickUpdateOrderStatus` (для обновления статуса по имени), а также в скриптах начальной инициализации данных для заполнения таблицы переходов `OrderStatusTransitions`.

### 2\. Функция `get_payment_status_id`

  * **Зачем? (Назначение):**
    Обеспечивает абстракцию от физических ID в таблице статусов платежей. Необходима для интеграции с внешними системами, которые присылают статусы в виде строк (например, ответ от банка "Success" или "Fail").

  * **Как? (Реализация):**
    Аналогична предыдущей, но обращается к таблице `PaymentStatusTypes`.

  * **Где? (Расположение и использование):**

      * **Определение:** Файл `oracle/01_schema/03_status_transitions.sql`.
      * **Использование:** В процедуре сверки платежей `sp_ReconcilePaymentStatuses`, где необходимо найти все платежи с текстовым статусом `'Pending'`.

### 3\. Функция `get_delivery_status_id`

  * **Зачем? (Назначение):**
    Служит для разрешения ID статусов доставки. Позволяет логике мониторинга доставок (например, поиск "зависших" посылок) быть читаемой и понятной.

  * **Как? (Реализация):**
    Обращается к таблице `DeliveryStatusTypes`. Возвращает `NULL`, если переданный ключ (например, `'OutForDelivery'`) отсутствует в справочнике.

  * **Где? (Расположение и использование):**

      * **Определение:** Файл `oracle/01_schema/03_status_transitions.sql`.
      * **Использование:** В процедуре мониторинга `sp_DeliveryMonitor`, которая ищет заказы, слишком долго находящиеся в статусе `'InTransit'`.

-----

### Пример интеграции (фрагмент для отчета)

Пример того, как использование этих функций делает код процедур чище (на примере `sp_QuickUpdateOrderStatus`):

```sql
-- БЕЗ функции (Плохо - магическое число):
UPDATE Orders SET order_STATUS_ID = 3 WHERE order_ID = p_OrderID; 
-- Что такое 3? Completed? Processing? Непонятно.

-- С функцией (AIC - Самодокументируемый код):
v_StatusID := get_order_status_id('Processing'); -- Явно запрашиваем ID для 'Processing'
UPDATE Orders SET order_STATUS_ID = v_StatusID WHERE order_ID = p_OrderID;
```

---

# Документация отдельных процедур (Standalone Procedures)

**Файл:** `oracle/04_procedures/standalone_academic.sql`
**Назначение:** Реализация административных и служебных функций, не требующих сложной инкапсуляции в пакеты.

## 1\. Обзор реализации

В дополнение к пакетной логике, в схеме базы данных реализован набор отдельных (standalone) хранимых процедур. Данные объекты предназначены для выполнения регламентных задач по обслуживанию данных и мониторингу целостности бизнес-процессов.

Архитектурно данные процедуры демонстрируют:

1.  **Взаимодействие с функциями:** Использование скалярных функций (`get_*_id`) для разрешения текстовых ключей в идентификаторы.
2.  **Курсорную обработку:** Использование явных курсоров для итеративного анализа наборов данных.
3.  **Административный контроль:** Предоставление инструментов для ручного вмешательства и аудита данных.

## 2\. Описание процедур

### 2.1. `sp_QuickUpdateOrderStatus`

  * **Тип:** Простая процедура (Simple Procedure).
  * **Назначение:** Оперативное изменение статуса заказа администратором с использованием мнемонического кода статуса (ключа) вместо числового идентификатора.
  * **Входные параметры:**
      * `p_OrderID` (NUMBER): Идентификатор заказа.
      * `p_StatusKey` (NVARCHAR2): Текстовый ключ нового статуса (например, `'Shipped'`).
  * **Реализация:**
      * Выполняется вызов вспомогательной функции `get_order_status_id` для получения ID статуса.
      * Производится валидация существования статуса.
      * Выполняется обновление таблицы `Orders` с фиксацией транзакции (`COMMIT`).

### 2.2. `sp_ReconcilePaymentStatuses`

  * **Тип:** Процедура с курсором (Cursor-based Procedure).
  * **Назначение:** Выявление логических несоответствий между статусом заказа и статусом оплаты (Data Integrity Check).
  * **Алгоритм работы:**
    1.  Объявляется явный курсор `c_Mismatch`.
    2.  В запросе курсора используется функция `get_payment_status_id` для фильтрации платежей со статусом `'Pending'`.
    3.  Выбираются заказы, имеющие статус `Completed` (ID=4), но неоплаченные счета.
    4.  В цикле `LOOP ... FETCH` формируются уведомления о найденных аномалиях.

### 2.3. `sp_DeliveryMonitor`

  * **Тип:** Процедура с курсором (Cursor-based Procedure).
  * **Назначение:** Мониторинг заказов, находящихся в доставке дольше нормативного срока (SLA Monitoring).
  * **Входные параметры:**
      * `p_DaysThreshold` (NUMBER): Пороговое значение дней, после которого доставка считается "зависшей".
  * **Реализация:**
      * Используется функция `get_delivery_status_id` для получения ID статуса `'InTransit'`.
      * Курсор `c_StuckDeliveries` выбирает заказы, отправленные ранее `SYSDATE - p_DaysThreshold`.
      * Осуществляется вывод контактных данных пользователей для инициации разбирательства.

### 2.4. `sp_ProductImageAudit`

  * **Тип:** Процедура с курсором (Cursor-based Procedure).
  * **Назначение:** Контроль качества заполнения каталога (Content Audit).
  * **Реализация:**
      * Курсор `c_NoImageProducts` использует конструкцию `NOT EXISTS` для поиска товаров в таблице `Products`, не имеющих связанных записей в таблице `ProductMedia`.
      * Результат выводится в консоль для работы контент-менеджеров.

-----

## 3\. Матрица соответствия требованиям (Compliance Matrix)

Данный набор процедур (в совокупности с ранее реализованными объектами) обеспечивает полное покрытие требований к курсовому проекту в части отдельных объектов БД.

| Требование | Реализация (Объект) | Детали реализации |
| :--- | :--- | :--- |
| **Функции (3 шт.)** | 1. `get_order_status_id`<br>2. `get_payment_status_id`<br>3. `get_delivery_status_id` | Реализованы как отдельные объекты (`CREATE FUNCTION`). |
| **Использование функций** | Внутри процедур | 1. `sp_QuickUpdateOrderStatus` (строка 16)<br>2. `sp_ReconcilePaymentStatuses` (строка 35)<br>3. `sp_DeliveryMonitor` (строка 58) |
| **Процедуры (5 шт.)** | 1. `sp_QuickUpdateOrderStatus`<br>2. `sp_ReconcilePaymentStatuses`<br>3. `sp_DeliveryMonitor`<br>4. `sp_ProductImageAudit`<br>5. `sp_LogBusinessAuditEvent` | Первые 4 реализованы в `standalone_academic.sql`. Пятая (`sp_LogBusinessAuditEvent`) реализована в модуле аудита. |
| **Процедуры с курсором (3 шт.)** | 1. `sp_ReconcilePaymentStatuses`<br>2. `sp_DeliveryMonitor`<br>3. `sp_ProductImageAudit` | Каждая процедура содержит объявление `CURSOR`, открытие `OPEN`, цикл `FETCH` и закрытие `CLOSE`. |

-----

*Документация отражает состояние схемы данных Oracle на момент релиза 1.1.0.*