# WinStore — Oracle Database

Это руководство — основная точка входа для работы с Oracle-версией базы данных WinStore. Оно содержит инструкции по быстрому запуску и карту ключевых разделов документации.

*Важно: Этот документ работает как "карта", и его ценность зависит от актуальности связанной документации. При изменении подсистем убедитесь, что вы обновляете и соответствующие документы.*

## Предварительные требования (Prerequisites)

Для работы с проектом вам понадобятся:

- **Docker & Docker Compose:** `Docker >= 20.10`, `Docker Compose >= v2.2`
- **Python:** `Python >= 3.10`
- **Git:** Любая современная версия.
- **Клиент Oracle:** `SQLcl` (рекомендуется) или `Oracle Instant Client` с утилитой `SQL*Plus`.

---

## Быстрый старт (Quick Start)

Этот раздел поможет вам развернуть, наполнить и проверить базу данных за четыре шага.

### Шаг 1: Подготовка окружения

1.  **Настройте переменные окружения**, скопировав файл `.env.example`:
    ```bash
    cp .env.example .env
    ```
    > **ВНИМАНИЕ:** Отредактируйте `.env` и задайте надежные пароли. Никогда не храните секреты в системе контроля версий.

2.  **Запустите Docker-контейнеры**:
    ```bash
    docker-compose up -d
    ```
    *Примечание: Первый запуск Oracle может занять несколько минут.*

### Шаг 2: Развертывание схемы

1.  **Подключитесь к базе данных** с правами администратора.
    ```bash
    sqlcl sys/your_password@localhost:1521/XEPDB1 as sysdba
    ```

2.  **Запустите мастер-скрипт развертывания**:
    ```sql
    @oracle/deploy.sql
    ```
    *Все логи развертывания сохраняются в директорию `oracle/logs/`.*

### Шаг 3: Наполнение данными

Для полноценной работы приложения необходимы тестовые данные.
> **Подробнее о генерации данных** читайте в [Руководстве по генерации данных](data_generation.md).
```bash
# Генерация базовых сущностей (пользователи, категории)
python3 scripts/data_generation/01_populate_base_entities.py

# Генерация товаров (например, видеокарты)
python3 scripts/data_generation/products/generate_gpus.py

# Генерация заказов и платежей
python3 scripts/data_generation/02_populate_orders.py
```

### Шаг 4: Проверка работоспособности

После развертывания и наполнения выполните интеграционный тест, чтобы убедиться, что PL/SQL пакеты и данные работают совместно.

1.  **Подключитесь к базе** под пользователем приложения (`winstore_app`), используя пароль из вашего `.env` файла.
2.  **Выполните в клиенте SQL** команду для включения вывода на экран:
    ```sql
    SET SERVEROUTPUT ON;
    ```
3.  **Запустите проверочный скрипт**:
    ```sql
    @oracle/06_query/check.sql
    ```
    *В случае успеха, вы увидите в консоли отформатированный фискальный чек для одного из случайно выбранных заказов. Это подтверждает, что вся цепочка от данных до PL/SQL логики работает корректно.*

> **Путь к автоматизации:** Текущая проверка является ручной. В будущем этот шаг можно улучшить, создав скрипт-обертку, который будет автоматически вызывать `check.sql` и проверять его вывод, возвращая четкий код успеха/неудачи (`exit code`). Это позволит встроить проверку в CI/CD пайплайны.

---

## Схема данных (ERD)

Визуальное представление схемы является ключевым для понимания связей между сущностями.

➡️ **[Смотреть схему данных (er_diagram.puml)](er_diagram.puml)**

*Для просмотра этого файла используйте плагин **PlantUML** для вашей IDE (VSCode, JetBrains) или любой онлайн-редактор PlantUML. Диаграмма поддерживается вручную, при изменении схемы БД не забудьте обновить и ее.*

---

## Ключевые принципы архитектуры

*   **Принцип "Глупой" базы данных**: Вся сложная бизнес-логика вынесена на уровень приложения. База данных отвечает только за хранение, целостность и быстрый доступ к данным.
*   **Декларативная целостность**: Целостность обеспечивается через `PRIMARY KEY`, `FOREIGN KEY`, `UNIQUE` и `CHECK` constraints.
*   **Минимальное использование триггеров**: Триггеры применяются только для технических задач. Подробнее см. в [Реестре триггеров](trigger_registry.md).
*   **Философия Absurdly Ideal Code**: Все решения подчиняются принципам простоты, надежности и производительности. Подробнее см. в гайде [AIC для баз данных](../../docs/aic_guide/database.md).

---

## Обзор подсистем и документации

Этот раздел поможет вам сориентироваться в документации.

*   **[Полный реестр документации](docs_map.md)**: Карта всех документов, связанных с Oracle.
*   **[Схема и данные](database_documentation_oracle.md)**: Полное текстовое описание таблиц, полей и связей.
*   **PL/SQL API**: Контракты процедур и функций для взаимодействия с бэкендом.
    *   [pkg_product_spec.md](pkg_product_spec.md), [pkg_order_spec.md](pkg_order_spec.md), [pkg_payment_spec.md](pkg_payment_spec.md), [pkg_user_spec.md](pkg_user_spec.md)
*   **[Безопасность](security_operations.md)**: Настройка TDE (шифрование), аудит, управление ролями.
*   **[Эксплуатация (Ops)](recovery.md)**: Процедуры бэкапа, восстановления и сброса.
*   **[Стандарты кода](SQL_style_guide.md)**: Правила оформления SQL и PL/SQL кода.

---

## Пользователи и роли базы данных

| Пользователь | Роль | Назначение |
| :--- | :--- | :--- |
| **WINSTORE_ADMIN** | `WINSTORE_ADMIN_ROLE` | Администратор схемы, владелец всех объектов. |
| **WINSTORE_APP** | `WINSTORE_APP_ROLE` | Учетная запись для подключения бэкенд-приложения. |
| **WINSTORE_MANAGER**| `WINSTORE_MANAGER_ROLE` | Роль для управления контентом (товары, категории). |
| **WINSTORE_DEV** | `WINSTORE_DEV_ROLE` | Роль для разработчиков с расширенными правами. |
| **WINSTORE_READONLY**| `WINSTORE_READONLY_ROLE`| Пользователь только для чтения (аналитика, BI). |
| **WINSTORE_BACKUP** | `WINSTORE_BACKUP_ROLE`| Специализированный пользователь для резервного копирования. |

---

## Версионирование (Versioning)

Настоящая документация описывает актуальное состояние основной ветки разработки (`main`). Стабильные версии проекта и соответствующая им документация могут быть найдены по `git`-тегам в репозитории.

Схема базы данных не использует автоматических миграций; каждая версия развертывается "с нуля" с помощью скрипта `deploy.sql`.

---

## Как внести свой вклад (Contributing)

### Философия
Всегда следуйте принципам **"Absurdly Ideal Code"**: максимальная простота, надежность и производительность.

### Стиль кода
Весь SQL и PL/SQL код должен соответствовать **[руководству по стилю](SQL_style_guide.md)**.

### Процесс
1.  Создайте новую ветку для вашей задачи (`feature/...`, `bugfix/...`).
2.  Внесите изменения.
3.  Убедитесь, что основные скрипты (`deploy.sql`, `reset.sql`) по-прежнему работают корректно.
4.  Если вы изменили логику или добавили новую, **обновите соответствующую документацию**.
5.  Создайте Pull Request с детальным описанием ваших изменений.

---

<details>
<summary><b>Справка для экспертов: Ключевые отличия от MS SQL</b></summary>

#### Ключевые изменения при миграции с MS SQL на Oracle

1.  **Типы данных**:
    *   `NVARCHAR` → `NVARCHAR2`
    *   `DATETIME` → `TIMESTAMP`
    *   `BIT` → `NUMBER(1)`
    *   `NVARCHAR(MAX)` → `NCLOB`

2.  **Автоинкрементные поля**:
    *   MS SQL `IDENTITY` заменены на комбинацию `SEQUENCE` и `BEFORE INSERT` триггеров. Для каждой таблицы создана последовательность `SEQ_[TableName]_ID`.

3.  **Синтаксические изменения**:
    *   Удалены операторы `GO`.
    *   `GETDATE()` заменен на `SYSTIMESTAMP`.

4.  **Процедуры и запросы**:
    *   `PIVOT` заменен на `DECODE` с `MAX`.
    *   Хранимые процедуры преобразованы в пакеты PL/SQL.
    *   `SCOPE_IDENTITY()` заменен на `RETURNING INTO`.

</details>
