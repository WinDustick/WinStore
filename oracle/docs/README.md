# WinStore Oracle Database Migration

## Обзор

Этот каталог содержит SQL-скрипты для Oracle версии базы данных платформы электронной коммерции WinStore. Скрипты адаптированы из исходных MS SQL Server скриптов с учетом синтаксических и архитектурных различий между системами.

## Важно: разделение проекта на MS SQL и Oracle

Проект разделяется на две части:
- Каталог `sql/` — MS SQL Server версия (остается без изменений и поддерживается отдельно).
- Каталог `oracle/` — Oracle версия (этот каталог является источником истины для дальнейшей работы с Oracle).

Архитектурные решения для Oracle теперь фиксируются ADR-файлами непосредственно в каталоге `oracle/adrs`.

## Ключевые изменения при миграции с MS SQL на Oracle

1. **Типы данных**:
   - `NVARCHAR` → `NVARCHAR2`
   - `DATETIME` → `TIMESTAMP`
   - `BIT` → `NUMBER(1)`
   - `NVARCHAR(MAX)` → `NCLOB`

2. **Автоинкрементные поля**:
   - MS SQL `IDENTITY` заменены на комбинацию последовательностей (`SEQUENCE`) и триггеров (`BEFORE INSERT`)
   - Для каждой таблицы создана отдельная последовательность SEQ_[TableName]_ID

3. **Синтаксические изменения**:
   - Удалены операторы `GO` (используются для разделения батчей в MS SQL)
   - Замена `GETDATE()` на `SYSTIMESTAMP`
   - Блоки для условной обработки перенесены в PL/SQL (DECLARE-BEGIN-END)
   - Использование `/` в качестве разделителя для PL/SQL блоков

4. **Пользовательские функции**:
   - Добавлены вспомогательные функции для статусов (get_order_status_id, get_payment_status_id, get_delivery_status_id)

5. **Представления и запросы**:
   - MS SQL PIVOT заменен на Oracle DECODE с MAX для транспонирования строк в столбцы
   - Индексированные представления заменены на материализованные представления (Materialized Views)
   
6. **Хранимые процедуры**:
   - MS SQL процедуры преобразованы в пакеты Oracle PL/SQL
   - Table-Valued Parameters заменены на Oracle Types и коллекции
   - SCOPE_IDENTITY() заменен на RETURNING INTO

7. **Система аудита**:
   - Серверная аудиторская система MS SQL заменена на Oracle Database Audit
   - Добавлены триггеры на ключевые таблицы для отслеживания изменений

8. **Имена таблиц и столбцов**:
   - Удалены префиксы схем `dbo.` (в Oracle используются другие механизмы)
   - Сохранены оригинальные имена таблиц и столбцов для совместимости с кодом приложения

## Последние изменения (2025-10-01)

Выполнены исправления и стандартизация Oracle-скриптов:
- Исправлены ошибки представлений с участием полей NCLOB (ORA-00932) с использованием `DBMS_LOB.SUBSTR(...)` и корректной агрегацией без включения NCLOB в `GROUP BY`.
- Материализованные представления переведены на `REFRESH COMPLETE ON DEMAND` (устранена ORA-12054 при `ON COMMIT`).
- Улучшено развертывание: добавлено подробное логирование через `SPOOL` в файл с меткой времени в `oracle/logs/`.
- Скрипт пользователей актуализирован: корректные пароли в кавычках, устранены недопустимые GRANT'ы, права указаны явно.
- Пакеты процедур согласованы со схемой: опора на триггеры авто-ID (`TRG_*_BI` + `SEQ_*`), корректные имена столбцов.
- Аудит Oracle настроен идемпотентно с поддержкой Unified Auditing (аккуратная обработка существующих политик).

## Логирование развертывания

Мастер-скрипт `deploy.sql` ведет подробный лог в каталоге `oracle/logs/` с именем вида:

- `oracle_deploy_YYYYMMDD_HH24MISSlog.lst`

Рекомендации:
- Убедитесь, что каталог `oracle/logs/` существует перед запуском.
- В консоли отображаются только ключевые сообщения, полная трассировка — в файле лога.

## Структура каталогов

- **`deploy.sql`** - Мастер-скрипт развертывания для Oracle
- **`01_schema/`** - Определение схемы базы данных Oracle
  - `01_core_schema.sql` - Создание таблиц, ограничений целостности, последовательностей и триггеров
  - `02_reference_data.sql` - Справочные таблицы и начальные данные
  - `03_status_transitions.sql` - Таблицы переходов между статусами и их начальные данные
  - `04_indexes.sql` - Все индексы базы данных
- **`02_audit/`** - Настройка системы аудита
  - `audit_setup.sql` - Конфигурация BusinessAuditLog и системы аудита Oracle
- **`03_views/`** - Представления базы данных
  - `product_views.sql` - Представления для данных о товарах (видеокарты, процессоры, RAM)
  - `system_views.sql` - Представления для статусов и системных данных
- **`04_procedures/`** - Хранимые процедуры
  - `product_procedures.sql` - Процедуры для управления товарами
  - `user_procedures.sql` - Процедуры для управления пользователями
  - `order_procedures.sql` - Процедуры для управления заказами
  - `payment_procedures.sql` - Процедуры для обработки платежей
- **`01_schema/05_users.sql`** - Создание пользователей базы данных с различными уровнями доступа

## Инструкции по развертыванию в Oracle

### Полное развертывание

Для развертывания всей базы данных в Oracle:

```sql
-- Подключение к Oracle с правами администратора (пример для SQLPlus)
sqlplus sys/password@pdb1 as sysdba

-- Запуск мастер-скрипта развертывания
@deploy.sql
```

### Пользователи базы данных

База данных WinStore использует следующих пользователей с различными уровнями привилегий:

1. **WINSTORE_ADMIN** - Администратор базы данных (полные права DBA)
   - Создается в начале процесса развертывания
   - Используется для выполнения всех скриптов создания объектов базы данных
   - Имеет полные права DBA с опцией ADMIN OPTION
   - Владелец всех объектов базы данных

2. **WINSTORE_MANAGER** - Пользователь для управления данными и объектами
   - Получает роль WINSTORE_MANAGER_ROLE
   - Имеет права на создание и изменение таблиц, представлений, процедур
   - Имеет полный доступ к объектам схемы WINSTORE_ADMIN
   - Используется для администрирования на уровне приложения

3. **WINSTORE_DEV** - Пользователь для разработчиков
   - Получает роль WINSTORE_DEV_ROLE
   - Имеет права на изменение объектов для целей разработки
   - Может создавать новые таблицы, представления и процедуры
   - Имеет полный доступ к объектам схемы WINSTORE_ADMIN

4. **WINSTORE_APP** - Пользователь для приложения
   - Получает роль WINSTORE_APP_ROLE
   - Имеет минимальные необходимые права для работы приложения
   - Имеет право EXECUTE на все пакеты PL/SQL (pkg_product, pkg_order, pkg_payment, pkg_user)
   - Имеет право SELECT на все представления схемы WINSTORE_ADMIN

5. **WINSTORE_READONLY** - Пользователь только для чтения
   - Получает роль WINSTORE_READONLY_ROLE
   - Имеет права только на чтение данных (SELECT) всех таблиц схемы WINSTORE_ADMIN
   - Используется для аналитики и отчетности

6. **WINSTORE_BACKUP** - Пользователь для резервного копирования
   - Получает роль WINSTORE_BACKUP_ROLE
   - Имеет специальные права для выполнения резервного копирования
   - Может экспортировать все данные из схемы WINSTORE_ADMIN

### Удаление базы данных

Для полного удаления всех объектов базы данных (сброс системы):

```sql
-- Подключение к Oracle (пример для SQLPlus)
sqlplus username/password@//hostname:port/service_name

-- Запуск скрипта удаления БД
@win_db_reset.sql
```

Скрипт сброса базы данных (win_db_reset.sql) удаляет все объекты в правильном порядке, с учетом зависимостей, обеспечивая чистую среду для последующего развертывания. Скрипт:
- Отключает все ограничения для избежания проблем с зависимостями
- Удаляет пакеты, процедуры и пользовательские типы
- Удаляет представления и материализованные представления
- Удаляет объекты аудита и триггеры
- Удаляет таблицы в обратном порядке зависимостей
- Удаляет индексы, синонимы, последовательности и другие оставшиеся объекты
- Удаляет пользователей и роли приложения
- Выполняет расширенную проверку успешности удаления с помощью:
  - Поиска оставшихся объектов с регистронезависимым сопоставлением имен
  - Попытки автоматического удаления обнаруженных объектов
  - Детальной отчетности о любых оставшихся объектах с указанием их типа
- Очищает корзину (PURGE RECYCLEBIN) для окончательной очистки помеченных на удаление объектов

Скрипт имеет интеллектуальную систему восстановления после ошибок, которая позволяет выполнить его повторно для удаления сложных объектов с зависимостями. Если первый проход не удаляет все объекты, выполните скрипт повторно для удаления оставшихся объектов.

### Частичное развертывание

Для разработки или обновления определенных компонентов:

1. Выполните только необходимые файлы скриптов в порядке зависимостей
2. Используйте SQLPlus или другой клиент Oracle
3. Соблюдайте последовательность (сначала схема, затем справочные данные и т.д.)

## Особенности Oracle, требующие внимания

1. **Права доступа**:
   - Убедитесь, что у пользователя Oracle есть необходимые привилегии для создания таблиц, последовательностей и триггеров
   - Для создания табличного пространства требуются привилегии администратора

2. **Индексы**:
   - Oracle поддерживает функциональные индексы
   - Синтаксис включающих индексов (`INCLUDE`) имеет некоторые различия

3. **Длина идентификаторов**:
   - Oracle имеет ограничение на длину идентификаторов (30 символов)
   - Все имена объектов соблюдают это ограничение

## Философия миграции

При миграции сохранена философия "Absurdly Ideal Code":
- **Простота**: Сохранение ясной структуры базы данных
- **Целостность данных**: Все ограничения целостности перенесены на Oracle
- **Разделение ответственности**: Бизнес-логика остается в приложении, база данных обеспечивает хранение и базовую целостность

## Известные отличия

1. **Каскадные операции**:
   - Oracle имеет некоторые отличия в обработке каскадных операций
   - Проверены и адаптированы все каскадные ограничения

2. **Последовательности**:
   - Последовательности в Oracle не гарантируют непрерывность значений (в отличие от IDENTITY)
   - Это не влияет на целостность данных, но может быть важно для некоторых приложений
   
3. **Пакеты PL/SQL**:
   - Хранимые процедуры MS SQL преобразованы в пакеты Oracle для лучшей организации
   - Использованы OUT параметры вместо возвращаемых наборов данных
   - SYS_REFCURSOR используется для возврата результатов запросов

## Документация и стандарты

- Соблюдайте внутренний стиль SQL и стандарты документирования (см. `oracle/docs/ORCL_SQL_style_guide.md` и ADR-009 "Стандарты документирования").
- Oracle ADR располагаются в `oracle/docs/adrs/`.
- Для Oracle-скриптов используйте стандартные заголовки файлов, описывающие назначение, автора, даты и зависимости.
