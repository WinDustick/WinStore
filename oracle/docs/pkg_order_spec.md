# Техническая спецификация модуля `pkg_order`

**Версия:** 1.0.1
**Дата:** 2025-10-20
**Модуль:** Управление заказами (Order Processing)

## 1\. Архитектура и принципы проектирования

Пакет `pkg_order` реализует транзакционный слой бизнес-логики (Transaction Layer) системы WinStore. В отличие от пакетов каталога, которые ориентированы на чтение, данный модуль управляет изменением состояния данных.

### 1.1. Управление жизненным циклом (State Management)

Пакет централизует логику жизненного цикла заказа. Изменение статусов (например, переход от `Created` к `Paid`) инкапсулировано в процедуры, что позволяет:

  * Гарантировать целостность переходов (предотвращение некорректных скачков статусов).
  * Обеспечить централизованную точку для триггеров аудита.

### 1.2. Транзакционная целостность

Процедуры пакета определяют границы атомарных операций:

  * Создание заказа (Header) и его позиций (Items) рассматривается как единый логический процесс.
  * Использование механизма `RETURNING INTO` для немедленного получения идентификаторов созданных сущностей без дополнительных запросов `SELECT`.

### 1.3. Абстракция структуры хранения

Модуль скрывает детали нормализации:

  * Клиентское приложение не обязано знать о разделении данных между таблицами `Orders` (заголовок), `OrderItems` (состав) и `Payments` (транзакции).
  * Данные возвращаются в денормализованном виде через курсоры `SYS_REFCURSOR`, готовые к отображению в UI (паттерн View Model).

## 2\. Спецификация процедур

### 2.1. Процедура `create_order`

Инициализирует процесс оформления заказа. Создает заголовок заказа для указанного пользователя и возвращает сгенерированный ID для дальнейшего наполнения товарами.

  * **Сигнатура:**

    ```sql
    PROCEDURE create_order(
        p_user_id  IN  NUMBER,
        p_order_id OUT NUMBER
    );
    ```

  * **Входные параметры:**

      * `p_user_id`: Идентификатор пользователя, совершающего покупку.

  * **Выходные параметры:**

      * `p_order_id`: Уникальный номер созданного заказа (Sequence `SEQ_ORDERS_ID`).

  * **Алгоритм реализации:**

    1.  **Валидация:** Проверка существования пользователя (обеспечивается FK Constraint `FK_Orders_Users` на уровне БД).
    2.  **Определение начального статуса:** Поиск ID статуса 'Created' (или 'Pending') в таблице справочнике `OrderStatusTypes`. Если статус не найден — выброс исключения.
    3.  **Вставка (Insert):** Создание записи в таблице `Orders` с текущей меткой времени (`SYSTIMESTAMP`) и нулевой суммой (`order_AMOUNT = 0`).
    4.  **Возврат ID:** Использование конструкции `RETURNING order_ID INTO p_order_id` для захвата сгенерированного ключа.
    5.  **Пост-условия:** Созданный заказ готов к добавлению позиций (Order Items).

### 2.2. Процедура `get_user_orders`

Возвращает историю заказов пользователя для отображения в личном кабинете.

  * **Сигнатура:**

    ```sql
    PROCEDURE get_user_orders(
        p_user_id IN  NUMBER,
        p_cursor  OUT SYS_REFCURSOR
    );
    ```

  * **Алгоритм реализации:**

    1.  **Выборка:** Запрос к таблице `Orders` с фильтрацией по `user_ID`.
    2.  **Джойны (Joins):**
          * `LEFT JOIN` с таблицей статусов (`OrderStatusTypes`) для получения текстового представления статуса.
          * `LEFT JOIN` с таблицей `Payments` (опционально) для отображения статуса оплаты.
    3.  **Агрегация (опционально):** Подсчет количества товаров в заказе (`COUNT` по `OrderItems`).
    4.  **Сортировка:** Строго по убыванию даты создания (`order_DATE DESC`), чтобы пользователь видел последние заказы первыми.
    5.  **Возвращаемые данные:** `order_id`, `order_date`, `status_name`, `total_amount`, `items_count`.

### 2.3. Процедура `get_order_details`

Возвращает детальный состав конкретного заказа (товарные позиции).

  * **Сигнатура:**

    ```sql
    PROCEDURE get_order_details(
        p_order_id IN  NUMBER,
        p_cursor   OUT SYS_REFCURSOR
    );
    ```

  * **Алгоритм реализации:**

    1.  **Выборка:** Запрос к таблице `OrderItems`, отфильтрованный по `order_ID`.
    2.  **Денормализация:** `INNER JOIN` с таблицей `Products` для получения актуального названия товара и `ProductMedia` для получения URL главного изображения.
    3.  **Фиксация цены:** Важно отметить, что выбирается цена из `OrderItems` (историческая цена продажи), а не из `Products` (текущая цена), чтобы обеспечить финансовую точность истории.
    4.  **Вычисляемые поля:** Расчет стоимости позиции (`quantity * price`).

### 2.4. Процедура `update_order_status`

Выполняет переход заказа на следующий этап обработки (например, "В сборке" -\> "Отправлен").

  * **Сигнатура:**

    ```sql
    PROCEDURE update_order_status(
        p_order_id      IN NUMBER,
        p_new_status_id IN NUMBER
    );
    ```

  * **Алгоритм реализации:**

    1.  **Блокировка (Concurrency Control):** (Рекомендуется) `SELECT ... FOR UPDATE` строки заказа, чтобы предотвратить одновременное изменение статуса разными менеджерами.
    2.  **Валидация перехода:**
          * Проверка текущего статуса заказа.
          * Сверка с матрицей допустимых переходов (таблица `StatusTransitions` или жестко закодированная логика `IF/CASE`). *Пример: Нельзя перевести заказ из "Delivered" в "Pending".*
    3.  **Обновление (Update):**
          * Установка `order_STATUS_ID = p_new_status_id`.
          * Обновление поля `updated_at`.
    4.  **Сайд-эффекты:** Триггер `TRG_AUDIT_ORDERS` автоматически фиксирует, кто и когда изменил статус, записывая старое и новое значение.

## 3\. Обработка исключительных ситуаций

Пакет использует централизованную обработку ошибок для защиты целостности данных:

  * **ORA-02291 (Integrity constraint violated - parent key not found):** Перехватывается при попытке создать заказ для несуществующего пользователя. Транслируется в понятную ошибку приложения "User not found".
  * **ORA-00054 (Resource busy):** Обрабатывается при попытке обновить статус заказа, который в данный момент редактируется другим процессом.
  * **Invalid Status Transition:** Генерируется пользовательское исключение (`RAISE_APPLICATION_ERROR` код -20002), если запрошен логически неверный переход статуса.

## 4\. Матрица соответствия академическим требованиям

Модуль `pkg_order` демонстрирует реализацию следующих концепций:

| Требование | Реализация в пакете | Описание |
| :--- | :--- | :--- |
| **DML Операции** | `INSERT`, `UPDATE` | Основные операции по созданию и модификации заказов. |
| **RETURNING Clause** | `create_order` | Оптимизация получения ID новой записи без повторного SELECT. |
| **Ссылочная целостность** | FK Handling | Работа со связанными таблицами (Orders -\> Users, OrderItems -\> Products). |
| **Курсорные переменные** | `SYS_REFCURSOR` | Унифицированный интерфейс возврата данных. |
| **Транзакционность** | Границы транзакций | Процедуры проектируются как атомарные единицы работы. |