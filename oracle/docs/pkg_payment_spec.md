# Техническая спецификация модуля `pkg_payment`

**Версия:** 1.0.0
**Дата:** 2025-10-20
**Модуль:** Финансовые транзакции (Financial Transactions Layer)

## 1\. Архитектура и принципы проектирования

Пакет `pkg_payment` реализует слой управления финансовыми данными. В отличие от других модулей, здесь критически важна точность состояний и прослеживаемость (Traceability).

### 1.1. Конечный автомат состояний (Finite State Machine)

Модуль не просто хранит данные, но и обеспечивает валидацию жизненного цикла платежа.

  * Логика допустимых переходов (например, `Pending` -\> `Completed`, но не `Failed` -\> `Pending`) вынесена в конфигурационные таблицы (`PaymentStatusTransitions`).
  * Пакет предоставляет методы для проверки валидности перехода до его совершения.

### 1.2. Атомарность операций

Процедуры изменения данных (`sp_CreatePayment`, `sp_UpdatePaymentStatus`) спроектированы как атомарные единицы работы. Они содержат явные команды управления транзакциями (`COMMIT`, `ROLLBACK`), гарантируя, что финансовая запись либо создана полностью, либо не создана вовсе.

### 1.3. Интеграционный слой

Пакет выступает адаптером между базой данных и внешними платежными шлюзами (Stripe, PayPal), обрабатываемыми на бэкенде. Он хранит внешние идентификаторы транзакций (`transaction_ID`) для сверки (Reconciliation).

## 2\. Спецификация процедур

### 2.1. Процедура `sp_CreatePayment`

Инициализирует запись о платеже. Вызывается сразу после создания заказа или при попытке повторной оплаты.

  * **Сигнатура:**

    ```sql
    PROCEDURE sp_CreatePayment(
        p_OrderID       IN  NUMBER,
        p_PaymentMethod IN  VARCHAR2,
        p_PaymentAmount IN  NUMBER,
        p_Currency      IN  CHAR,
        p_TransactionID IN  VARCHAR2,
        p_PaymentID     OUT NUMBER
    );
    ```

  * **Параметры:**

      * `p_TransactionID`: Идентификатор, полученный от платежной системы (Intent ID) или сгенерированный временно.
      * `p_PaymentID`: Возвращаемый ID созданной записи.

  * **Алгоритм реализации:**

    1.  **Инициализация:** Вставка записи в таблицу `Payments`.
    2.  **Статус по умолчанию:** Полю `payment_STATUS_ID` жестко присваивается значение `1` (Pending), так как любой новый платеж ожидает подтверждения.
    3.  **Аудит:** Поля `created_at` и `updated_at` инициализируются текущим серверным временем (`SYSDATE`).
    4.  **Возврат ключа:** Использование `RETURNING payment_ID INTO ...`.
    5.  **Фиксация:** Выполнение `COMMIT`.

### 2.2. Процедура `sp_UpdatePaymentStatus`

Обновляет состояние платежа на основе ответа (Webhook/Callback) от платежного шлюза.

  * **Сигнатура:**

    ```sql
    PROCEDURE sp_UpdatePaymentStatus(
        p_PaymentID     IN NUMBER,
        p_NewStatusID   IN NUMBER,
        p_TransactionID IN VARCHAR2 DEFAULT NULL
    );
    ```

  * **Бизнес-логика:**

      * Позволяет обновить не только статус, но и уточнить `transaction_ID` (например, если шлюз прислал финальный ID транзакции только после успешной оплаты). Использование `NVL` сохраняет старый ID, если новый не передан.
      * Автоматически обновляет `updated_at`.
      * В случае ошибки выполняет `ROLLBACK` и пробрасывает исключение наверх.

### 2.3. Процедура `sp_ValidatePaymentStatusTransition`

Служебная процедура для проверки бизнес-правил перехода статусов.

  * **Сигнатура:**

    ```sql
    PROCEDURE sp_ValidatePaymentStatusTransition(
        p_FromStatusID   IN  NUMBER,
        p_ToStatusID     IN  NUMBER,
        p_IsValid        OUT NUMBER,
        p_TransitionName OUT VARCHAR2
    );
    ```

  * **Алгоритм:**

    1.  Выполняет поиск в таблице `PaymentStatusTransitions`.
    2.  Возвращает `1` (True) в `p_IsValid`, если переход найден и флаг `is_allowed = 1`.
    3.  В случае `NO_DATA_FOUND` корректно возвращает `0` (False), не прерывая выполнение ошибкой. Это позволяет бэкенду мягко обрабатывать логические ошибки.

### 2.4. Процедура `sp_GetAvailablePaymentStatusTransitions`

Возвращает список возможных следующих шагов для текущего состояния платежа. Используется административной панелью для отрисовки доступных кнопок действий (например, для статуса "Paid" может быть доступна кнопка "Refund", но не "Cancel").

  * **Сигнатура:**

    ```sql
    PROCEDURE sp_GetAvailablePaymentStatusTransitions(
        p_CurrentStatusID IN  NUMBER,
        p_cursor          OUT SYS_REFCURSOR
    );
    ```

  * **Возвращаемые данные (Cursor):**

      * `to_status_ID`: ID целевого статуса.
      * `status_KEY`: Код статуса (для программной обработки).
      * `status_NAME_RU/EN`: Локализованное название (для UI).
      * `transition_name`: Название действия (например, "Оформить возврат").

## 3\. Матрица соответствия академическим требованиям

Модуль `pkg_payment` демонстрирует реализацию следующих концепций:

| Требование | Реализация в пакете | Описание |
| :--- | :--- | :--- |
| **Управление транзакциями** | `COMMIT`, `ROLLBACK` | Явное управление целостностью внутри хранимых процедур. |
| **Out-параметры** | `p_IsValid`, `p_PaymentID` | Возврат скалярных значений из процедур. |
| **Слабая типизация Boolean** | `NUMBER (0/1)` | Эмуляция булева типа для совместимости с SQL-слоем Oracle. |
| **Обработка исключений** | `WHEN OTHERS`, `NO_DATA_FOUND` | Разделение обработки критических ошибок и ошибок бизнес-логики. |
| **Реляционная целостность** | `JOIN` в курсоре | Объединение таблиц переходов и типов статусов. |