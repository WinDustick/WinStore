# Техническая спецификация модуля `pkg_user`

**Версия:** 1.0.0
**Дата:** 2025-10-20
**Модуль:** Управление пользователями и Доступом (Identity & Access Management)

## 1\. Архитектура и принципы проектирования

Пакет `pkg_user` реализует слой управления идентичностью (Identity Management Layer). Он централизует все операции, связанные с жизненным циклом учетных записей, аутентификацией и безопасностью пользовательских данных.

### 1.1. Валидация данных на уровне БД

Пакет реализует стратегию "Defence in Depth" (Глубокая защита), дублируя критические проверки бизнес-логики на уровне базы данных:

  * **Уникальность Email:** Проверка осуществляется с учетом регистра (`UPPER`), предотвращая создание дублей вида `User@example.com` и `user@example.com`.
  * **Целостность транзакций:** Операции создания и модификации пользователей являются атомарными. Ошибка в любом поле приводит к полному откату изменений (`ROLLBACK`).

### 1.2. Безопасность

  * **Инкапсуляция паролей:** Пакет предоставляет интерфейс для смены пароля (`sp_UpdateUserPassword`), скрывая прямой доступ к таблице `Users`.
  * **Ролевая модель:** При создании пользователю автоматически назначается роль по умолчанию ('User'), что предотвращает случайное создание администраторов через публичное API.

## 2\. Спецификация процедур

### 2.1. Процедура `sp_CreateUser`

Регистрация нового пользователя в системе.

  * **Сигнатура:**

    ```sql
    PROCEDURE sp_CreateUser(
        p_user_NAME     IN  VARCHAR2,
        p_user_EMAIL    IN  VARCHAR2,
        p_user_PHONE    IN  VARCHAR2,
        p_user_PASSWORD IN  VARCHAR2,
        p_user_ID       OUT NUMBER
    );
    ```

  * **Алгоритм реализации:**

    1.  **Проверка дубликатов:** Выполняется `SELECT COUNT(*)` с условием `UPPER(user_EMAIL)`. Если найдены совпадения, генерируется исключение приложения `RAISE_APPLICATION_ERROR(-20001)`.
    2.  **Вставка:** Создание записи в таблице `Users` с текущим временем регистрации.
    3.  **Возврат ID:** Использование `RETURNING user_ID INTO` для возврата сгенерированного ключа.
    4.  **Фиксация:** Явный `COMMIT` транзакции.

### 2.2. Процедура `sp_AuthenticateUser`

Проверка учетных данных пользователя (Login).

  * **Сигнатура:**

    ```sql
    PROCEDURE sp_AuthenticateUser(
        p_user_EMAIL    IN  VARCHAR2,
        p_user_PASSWORD IN  VARCHAR2,
        p_cursor        OUT SYS_REFCURSOR
    );
    ```

  * **Логика:**

      * Открывает курсор с данными пользователя только в том случае, если найдена запись с совпадающим Email (без учета регистра) и паролем.
      * Если пара логин/пароль неверна, курсор будет пустым (клиентское приложение интерпретирует это как ошибку аутентификации).
      * *Примечание:* В реальной среде сравнение паролей должно производиться через функцию хеширования (например, `DBMS_CRYPTO`), в текущей академической реализации — прямое сравнение.

### 2.3. Процедура `sp_UpdateUser`

Обновление профиля пользователя.

  * **Сигнатура:**

    ```sql
    PROCEDURE sp_UpdateUser(
        p_user_ID    IN NUMBER,
        p_user_NAME  IN VARCHAR2,
        p_user_EMAIL IN VARCHAR2,
        p_user_PHONE IN VARCHAR2
    );
    ```

  * **Особенность реализации:**

      * Содержит сложную проверку уникальности Email: "Разрешить смену Email, если новый Email не занят *другим* пользователем (`user_ID != p_user_ID`)".
      * Это предотвращает коллизии при редактировании профиля.

### 2.4. Процедура `sp_SearchUsers`

Поиск пользователей администратором с поддержкой пагинации.

  * **Сигнатура:**

    ```sql
    PROCEDURE sp_SearchUsers(
        p_search_TERM IN  VARCHAR2,
        p_page_NUMBER IN  NUMBER DEFAULT 1,
        p_page_SIZE   IN  NUMBER DEFAULT 20,
        p_cursor      OUT SYS_REFCURSOR
    );
    ```

  * **Алгоритм (Window Functions):**

    1.  **Фильтрация:** Поиск подстроки (`LIKE %...%`) одновременно по имени, email и телефону.
    2.  **Нумерация строк:** Использование аналитической функции `ROW_NUMBER() OVER (ORDER BY user_NAME)` для присвоения порядкового номера каждому результату.
    3.  **Пагинация:** Обертывание запроса в `SELECT * FROM (...) WHERE row_num BETWEEN X AND Y`. Этот метод (в отличие от `OFFSET/FETCH`) работает во всех поддерживаемых версиях Oracle.

## 3\. Матрица соответствия академическим требованиям

Модуль `pkg_user` демонстрирует использование следующих конструкций языка PL/SQL:

| Требование | Реализация в пакете | Описание |
| :--- | :--- | :--- |
| **Аналитические функции** | `ROW_NUMBER() OVER` | Реализация пагинации в процедуре поиска. |
| **Пользовательские исключения** | `RAISE_APPLICATION_ERROR` | Генерация ошибок бизнес-логики (код -20001) с понятным текстом. |
| **Управление транзакциями** | `COMMIT`, `ROLLBACK` | Гарантия атомарности операций регистрации и обновления. |
| **Работа со строками** | `UPPER`, `LIKE` | Регистронезависимый поиск и сравнение. |
| **Параметры по умолчанию** | `DEFAULT` | Использование дефолтных значений для пагинации (`p_page_NUMBER`, `p_page_SIZE`). |