# Техническая документация модуля `pkg_rgr_analytics`

**Версия:** 1.1.0
**Дата:** 2025-11-18

## 1\. Архитектура и принципы проектирования

При разработке аналитического модуля использован подход, основанный на разделении ответственности (Separation of Concerns). Логика извлечения и обработки данных отделена от логики их представления.

### 1.1. Слой данных (Data Layer)

Пакет `pkg_rgr_analytics` (PL/SQL) выполняет функции извлечения, агрегации и предварительной обработки данных.

  * Сложные SQL-запросы и бизнес-правила (расчет скидок, определение категорий клиентов) инкапсулированы внутри пакета.
  * Возврат данных осуществляется посредством курсоров (`SYS_REFCURSOR`), что обеспечивает передачу структурированных наборов данных вызывающей стороне.
  * Форматирование вывода (визуализация) внутри процедур пакета не производится.

### 1.2. Слой представления (Presentation Layer)

Клиентское приложение (в данном контексте эмулируется скриптом `test_rgr_analytics.sql`) отвечает за получение данных из курсоров и их отображение.

## 2\. Спецификация пакета (Интерфейс)

Спецификация пакета определяет публичный интерфейс взаимодействия, типы данных и доступные методы.

### 2.1. Константы и типы данных

Для обеспечения строгой типизации и централизованного управления форматами в спецификации объявлены:

  * **Константы:** `c_money_mask` (маска форматирования денежных величин) и `c_report_separator` (разделитель для отчетов).
  * **Типы записей (`RECORD`):** `t_CatStatsRec`, `t_DormantUserRec`, `t_ReceiptItemRec`. Использование явных типов записей фиксирует структуру возвращаемых данных.

### 2.2. Объявление курсоров

В спецификации определены заголовки курсоров (`c_CategoryStats`, `c_DormantUsers` и др.). Это позволяет декларировать структуру выборки данных до реализации тела пакета.

### 2.3. Публичные функции

Функции `f_FormatPrice`, `f_CalculateLoyaltyTier` и `f_HasActivePromo` объявлены в спецификации. Публичное объявление необходимо для обеспечения возможности вызова данных функций внутри SQL-запросов, выполняемых в процедурах пакета.

## 3\. Реализация пакета (Package Body)

Тело пакета содержит реализацию объявленных курсоров, функций и процедур, а также скрытые (приватные) компоненты.

### 3.1. Механизм аудита (Скрытая процедура)

Процедура `log_report_exec` предназначена для регистрации фактов запуска отчетов.

  * **Принцип работы:** Используется прагма `PRAGMA AUTONOMOUS_TRANSACTION`. Данная конструкция позволяет выполнять запись в журнал в рамках независимой транзакции. Фиксация (`COMMIT`) записи аудита происходит независимо от результата выполнения основной транзакции (успешное завершение или откат).
  * **Инкапсуляция:** Процедура не объявлена в спецификации пакета, что исключает возможность её прямого вызова извне и обеспечивает целостность журнала аудита.

### 3.2. Вспомогательные функции бизнес-логики

  * **`f_CalculateLoyaltyTier`:** Выполняет сегментацию клиентов на основе общей суммы покупок. Используется условная логика (`IF ... ELSIF`) для определения категории (Platinum, Gold, Silver, Bronze). Функция вызывается внутри SQL-запроса курсора `c_DormantUsers`.
  * **`f_HasActivePromo`:** Определяет наличие активных промо-акций для указанной категории товаров в текущий момент времени. Выполняется проверка в таблицах `Promotions` и `PromotionApplications` с учетом временного интервала. Возвращается числовое значение (`1` или `0`), так как тип `BOOLEAN` не поддерживается в SQL-запросах Oracle.

### 3.3. Процедуры формирования отчетов

Процедуры реализуют унифицированный алгоритм:

1.  Регистрация вызова через процедуру аудита.
2.  Инициализация и открытие курсора (`OPEN ... FOR`), связанного с SQL-запросом.
3.  Возврат открытого курсора через выходной параметр `OUT SYS_REFCURSOR`.

<!-- end list -->

  * **`sp_CategoryPerformanceReport`:** Формирует отчет об эффективности продаж. SQL-запрос включает агрегацию данных, фильтрацию и вызов PL/SQL функций для форматирования и обогащения данных.
  * **`sp_GenerateReceiptDetails`:** Формирует детализацию заказа (фискальный документ). Выполняется соединение таблиц `OrderItems` и `Products`. Цены приводятся к единому формату посредством функции `f_FormatPrice`.

### 3.4. Служебные процедуры

  * **`sp_RefreshStatsCache`:** Реализует логику проверки складских остатков. Используется явный курсор `c_LowStockItems`, объявленный в теле пакета. Обработка данных производится итеративно (построчно) в цикле `LOOP ... FETCH`.
  * **`sp_ArchiveAuditLogs`:** Выполняет операции по обслуживанию журнала аудита (архивация устаревших записей).

## 4\. Матрица соответствия функциональным требованиям

Реализация пакета `pkg_rgr_analytics` соответствует заявленным требованиям к разработке серверных модулей СУБД.

| Требование | Реализация | Описание |
| :--- | :--- | :--- |
| **Процедуры (5 шт.)** | `pkg_rgr_analytics` | Включает 3 процедуры отчетности и 2 служебные процедуры. |
| **Процедуры с курсором (3 шт.)** | `sp_CategoryPerformanceReport`<br>`sp_DormantCustomersReport`<br>`sp_GenerateReceiptDetails` | Используют возвращаемый параметр типа `SYS_REFCURSOR`. |
| **Функции (3 шт.)** | `f_FormatPrice`<br>`f_CalculateLoyaltyTier`<br>`f_HasActivePromo` | Реализуют вспомогательную бизнес-логику. |
| **Использование функций в процедурах** | `PACKAGE BODY` | Функции вызываются в контексте SQL-запросов внутри процедур. |
| **Явные курсоры (2 шт.)** | `c_LowStockItems`<br>`c_CategoryStats` и др. | Объявлены в спецификации, реализация запросов находится в теле пакета. |
| **Скрытая процедура** | `log_report_exec` | Реализована только в теле пакета, использует автономные транзакции. |
| **Триггеры** | `oracle/05_triggers/` | Реализованы триггеры для аудита и автоматического обновления полей. |