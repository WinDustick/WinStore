# Руководство по стилю SQL (Oracle) для проекта WinStore

Это руководство адаптировано для Oracle Database. Оно дополняет общее руководство и устраняет различия, характерные для MS SQL.

## Заголовки файлов
```sql
-- =====================================================================
-- WinStore - [Название компонента]
-- =====================================================================
-- Description: [Краткое описание содержимого файла]
-- Author:      WinStore Development Team
-- Created:     [Дата создания в формате YYYY-MM-DD]
-- Modified:    [Дата последнего изменения в формате YYYY-MM-DD]
-- Version:     [Версия в формате X.Y.Z]
-- =====================================================================
-- Dependencies: [Список файлов, от которых зависит данный файл]
-- =====================================================================
```

## Именование объектов

- Схема по умолчанию: без префикса `dbo.`.
- Идентификаторы ограничены 30 символами.
- Последовательности: `SEQ_[Table]_ID`
- Триггеры: `TRG_[Table]_BI` для BEFORE INSERT автонумерации.
- Пакеты: `pkg_[domain]` (например, `pkg_product`).
- Материализованные представления: `mv_[name]`.

## Типы данных и функции

- NVARCHAR → NVARCHAR2, DATETIME → TIMESTAMP, NVARCHAR(MAX) → NCLOB.
- Тексты NCLOB в выражениях/агрегациях: `DBMS_LOB.SUBSTR(clob_col, 2000, 1)`.
- Даты/время: `SYSTIMESTAMP`.

## Синтаксис и форматирование

- Ключевые слова ПРОПИСНЫМИ.
- Отступы: 4 пробела.
- Всегда указывайте схему, если объект не в текущей схеме.
- Нет `GO`. PL/SQL блоки завершаются `/` на новой строке.

## Запросы и представления

- Замена MS SQL PIVOT: `MAX(DECODE(...))`.
- Не включать NCLOB в `GROUP BY`; при необходимости агрегировать через `MAX(DBMS_LOB.SUBSTR(...))`.
- Для фильтров по текстам больших полей использовать полнотекст (если доступен) или ограничивать длину через SUBSTR.

## Материализованные представления

- Режим: `BUILD IMMEDIATE REFRESH COMPLETE ON DEMAND`.
- Избегать `ON COMMIT`, если задействованы неподдерживаемые конструкции.

## Пакеты PL/SQL

- Структура: спецификация и тело; возвращаемые наборы — через `SYS_REFCURSOR`.
- Авто-ID через триггеры, избегать прямого обращения к последовательностям в приложении.
- Обработка ошибок: `EXCEPTION WHEN OTHERS THEN` с логированием при необходимости.

## Пользователи и права

- Пароли в кавычках, если содержат спецсимволы/начинаются с цифры.
- Избегать недопустимых GRANT'ов; использовать роли (`EXP_FULL_DATABASE` и т.п.).
- Явно перечислять объектные права: `SELECT, INSERT, UPDATE, DELETE`.

## Развертывание и логирование

- Использовать `SPOOL` для лога с меткой времени в `oracle/logs/`.
- Управлять выводом в консоль параметрами SQL*Plus/SQLcl (TERMOUT/FEEDBACK и др.).

## Производительность

- Индексы на JOIN/WHERE/ORDER BY столбцы; учитывать ограничения 30 символов.
- Функциональные индексы при необходимости (например, на `UPPER(column)`).

## Примеры

```sql
CREATE OR REPLACE VIEW view_product_sample AS
SELECT
    p.product_ID,
    p.product_NAME,
    MAX(DBMS_LOB.SUBSTR(p.product_DESCRIPT, 2000, 1)) AS product_DESCRIPT_2k,
    c.category_NAME
FROM Products p
JOIN Categories c ON c.category_ID = p.category_ID
GROUP BY p.product_ID, p.product_NAME, c.category_NAME;
```

```sql
CREATE MATERIALIZED VIEW mv_product_summary
BUILD IMMEDIATE
REFRESH COMPLETE ON DEMAND
AS
SELECT p.product_ID, p.product_NAME FROM Products p;
```

## Заключение

Это руководство предназначено для Oracle-ветви проекта и должно использоваться вместо общего MS SQL стайлгайда при работе в каталоге `oracle/`.
