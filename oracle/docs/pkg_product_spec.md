# Техническая спецификация модуля `pkg_product`

**Версия:** 1.0.1
**Дата:** 2025-10-20
**Модуль:** Управление каталогом товаров (Catalog Management)

## 1\. Архитектура и принципы проектирования

Пакет `pkg_product` реализует слой доступа к данным (DAL) для основной сущности системы — товаров. При проектировании пакета использованы следующие архитектурные паттерны:

### 1.1. Абстракция доступа к данным

Пакет полностью инкапсулирует сложную реляционную структуру базы данных (схема «Звезда» или «Снежинка», где товар связан с вендорами, категориями и атрибутами).

  * Для вызывающей стороны (Backend Application) предоставляется плоский или JSON-структурированный интерфейс.
  * Все операции чтения возвращают данные через слабые курсоры (`SYS_REFCURSOR`), что позволяет изменять внутреннюю реализацию запросов без перекомпиляции клиентского кода.

### 1.2. Оптимизация чтения (Read-Heavy Optimization)

Поскольку каталог товаров является наиболее часто запрашиваемым ресурсом, процедуры пакета оптимизированы для чтения:

  * Использование прямых соединений (`JOIN`) вместо вложенных подзапросов, где это возможно.
  * Использование нативных функций генерации JSON (`JSON_OBJECT`, `JSON_ARRAYAGG`) на стороне СУБД для минимизации трафика сети (передача одного CLOB объекта вместо множества строк для атрибутов).

## 2\. Спецификация процедур

### 2.1. Процедура `get_product_by_id`

Возвращает детальную информацию о конкретном товаре, включая связанные справочники и технические характеристики.

  * **Сигнатура:**

    ```sql
    PROCEDURE get_product_by_id(
        p_product_id IN  NUMBER,
        p_cursor     OUT SYS_REFCURSOR
    );
    ```

  * **Входные параметры:**

      * `p_product_id`: Уникальный идентификатор товара. Обязательный параметр.

  * **Алгоритм реализации:**

    1.  **Валидация:** Проверка входного параметра на `NULL` (неявная, через тип данных).
    2.  **Формирование выборки:** Выполняется запрос к таблице `Products` с присоединением (`LEFT JOIN`) таблиц `Vendors` и `Categories` для получения человекочитаемых названий.
    3.  **Агрегация атрибутов:** Выполняется коррелированный подзапрос к таблице `ProductAttributes` и `Attributes`. Пары "Название атрибута — Значение" агрегируются в единый JSON-объект или форматированную строку (в зависимости от версии Oracle XE), чтобы избежать проблемы "N+1 запросов" на клиенте.
    4.  **Открытие курсора:** Результат (одна строка или пустой набор) передается в `p_cursor`.

  * **Возвращаемая структура данных (Cursor):**
    | Поле | Тип | Описание |
    | :--- | :--- | :--- |
    | `product_id` | NUMBER | ID товара |
    | `product_name` | NVARCHAR2 | Наименование |
    | `category_name` | NVARCHAR2 | Название категории |
    | `vendor_name` | NVARCHAR2 | Название производителя |
    | `price` | NUMBER | Текущая цена |
    | `stock_quantity` | NUMBER | Остаток на складе |
    | `specs_json` | CLOB (JSON) | Агрегированные характеристики (Key-Value) |

### 2.2. Процедура `get_all_products_paged`

Реализует вывод списка товаров с поддержкой серверной пагинации. Является основным источником данных для витрины магазина.

  * **Сигнатура:**

    ```sql
    PROCEDURE get_all_products_paged(
        p_offset IN  NUMBER,
        p_limit  IN  NUMBER,
        p_cursor OUT SYS_REFCURSOR
    );
    ```

  * **Бизнес-логика и параметры:**

      * `p_offset`: Количество пропускаемых записей (смещение). Если `NULL` или \< 0, принимается за 0.
      * `p_limit`: Размер страницы. Если `NULL` или \<= 0, устанавливается значение по умолчанию (например, 20). Максимальное значение может быть ограничено внутри процедуры для защиты от DoS.

  * **Алгоритм реализации:**

    1.  **Нормализация параметров:** Приведение `p_offset` и `p_limit` к допустимым значениям.
    2.  **Запрос:** Выборка из представления `mv_product_summary` (или таблицы `Products`).
    3.  **Фильтрация:** Применяется условие `is_active = 1` (скрытие архивных товаров).
    4.  **Сортировка:** Жесткая детерминированная сортировка (например, `ORDER BY created_at DESC, product_id ASC`) необходима для корректной работы пагинации (`OFFSET ... FETCH NEXT`).
    5.  **Возврат:** Курсор возвращает только основные поля, необходимые для предпросмотра (Card View), без тяжелых полей описания.

### 2.3. Процедура `search_products`

Осуществляет полнотекстовый поиск по каталогу.

  * **Сигнатура:**

    ```sql
    PROCEDURE search_products(
        p_query  IN  NUMBER,
        p_cursor OUT SYS_REFCURSOR
    );
    ```

  * **Алгоритм реализации:**

    1.  **Препроцессинг запроса:** Входная строка `p_query` очищается от лишних пробелов, приводится к нижнему регистру (`LOWER`).
    2.  **Паттерн поиска:** Формируется маска поиска `v_pattern := '%' || v_clean_query || '%'`.
    3.  **Выполнение поиска:** Запрос ищет совпадения в полях `product_NAME` и `product_DESCRIPT`. В расширенной версии также проверяется имя вендора.
    4.  **Ранжирование (опционально):** Результаты, где совпадение найдено в названии товара, выводятся выше, чем совпадения в описании.

### 2.4. Процедура `get_products_by_category`

Фильтрует товары по конкретной категории.

  * **Сигнатура:**

    ```sql
    PROCEDURE get_products_by_category(
        p_category_id IN  NUMBER,
        p_cursor      OUT SYS_REFCURSOR
    );
    ```

  * **Алгоритм реализации:**

    1.  Прямая фильтрация таблицы `Products` по внешнему ключу `category_ID`.
    2.  Аналогично процедуре пагинации, возвращаются только активные товары (`is_active = 1`).

## 3\. Обработка исключительных ситуаций

В пакете применяется стандартная стратегия обработки ошибок:

  * Ошибки валидации входных данных (например, отрицательный ID) могут вызывать пользовательское исключение (`RAISE_APPLICATION_ERROR` с кодом -2000X).
  * Системные ошибки (например, сбой соединения) пробрасываются вызывающему коду для логирования на уровне приложения.
  * Ситуация "Товар не найден" в процедуре `get_product_by_id` не вызывает исключение, а возвращает пустой курсор (или курсор без строк), что должно корректно обрабатываться бэкендом.

## 4\. Матрица соответствия академическим требованиям

Реализация пакета `pkg_product` демонстрирует владение следующими технологиями разработки БД Oracle:

| Требование | Реализация в пакете | Описание |
| :--- | :--- | :--- |
| **Пакетирование** | `CREATE PACKAGE` | Логика сгруппирована в модульную структуру (Spec + Body). |
| **Курсоры** | `SYS_REFCURSOR` | Использование курсорных переменных для возврата данных клиенту. |
| **Соединения (Joins)** | `LEFT JOIN`, `INNER JOIN` | Объединение данных из 4 таблиц (`Products`, `Vendors`, `Categories`, `Attributes`). |
| **Агрегатные функции** | `JSON_ARRAYAGG` / `LISTAGG` | Сборка атрибутов товара в одну строку/объект. |
| **Пагинация** | `OFFSET ... FETCH` | Реализация эффективной выборки части данных (ANSI SQL standard). |
| **Работа с NULL** | `NVL`, `COALESCE` | Обработка необязательных полей (например, описания). |